<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Options Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a2526; font-family: 'Helvetica Neue', Arial, sans-serif; color: #ffffff; overscroll-behavior: none; }
        .container { max-width: 1400px; margin-top: 30px; padding: 0 15px; }
        .card { background-color: #2a3637; border: none; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .card-header { background-color: #1a2526; color: #ffffff; border-radius: 8px 8px 0 0; font-weight: 500; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .form-label { font-weight: 400; color: #d3d7d8; font-size: 0.95rem; }
        .form-control, .form-select { background-color: #3c4b4c; color: #ffffff; border: 1px solid #4a5a5b; border-radius: 5px; }
        .form-control:focus, .form-select:focus { border-color: #f5a623; box-shadow: 0 0 5px rgba(245,166,35,0.5); }
        .dashboard-metric { background-color: #2a3637; padding: 20px; border-radius: 6px; text-align: center; box-shadow: 0 2px4pxrgba(0,0,0,0.2); height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .dashboard-metric h5 { color: #a0a8a9; margin-bottom: 10px; font-size: 0.85rem; }
        .dashboard-metric p { font-size: 1.3rem; font-weight: 500; color: #f5a623; margin: 0; }
        .table { background-color: #2a3637; border-radius: 6px; overflow: hidden; color: #ffffff; }
        .table th { background-color: #1a2526; color: #ffffff; font-weight: 500; font-size: 0.95rem; padding: 12px; cursor: pointer; }
        .table td { background-color: #2a3637; color: #d3d7d8; font-size: 0.9rem; padding: 10px; border-top: 1px solid #4a5a5b; }
        .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: #323f40; }
        .metric-value { color: #e6951e; font-weight: 500; }
        .delete-btn { display: none; cursor: pointer; color: #ff6b6b; font-weight: bold; }
        tr:hover .delete-btn { display: inline; }
        tr:hover td { background-color: #3c4b4c; }
        .btn-custom { background-color: #f5a623; color: #ffffff; font-weight: 500; border: none; border-radius: 5px; padding: 8px 16px; }
        .btn-custom:hover { background-color: #d88f1f; }
        .editable-input { background-color: #3c4b4c; color: #ffffff; border: 1px solid #4a5a5b; border-radius: 4px; padding: 2px 5px; width: 100px; }
        .manual-input { color: #f5a623 !important; }
        .highlight-expiration { color: #f5a623 !important; }
        .yearly-yield-high { color: #f5a623; font-weight: bold; }
        .upload-section { display: flex; align-items: center; gap: 10px; }
        .upload-section input[type="file"] { display: none; }
        .upload-section label { background-color: #f5a623; color: #ffffff; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .checkbox-container { display: flex; align-items: center; justify-content: center; height: 100%; }
        .nav-tabs .nav-link { background-color: #2a3637; color: #d3d7d8; border: 1px solid #4a5a5b; border-radius: 5px; margin-right: 5px; }
        .nav-tabs .nav-link.active { background-color: #f5a623; color: #ffffff; border-color: #f5a623; }
        .year-tabs-container { display: flex; align-items: center; gap: 10px; }
        .chart-container { position: relative; width: 100%; height: 400px; background-color: #2a3637; border-radius: 6px; padding: 10px; }
        @media (max-width: 768px) { .dashboard-metric { height: auto; margin-bottom: 10px; } }
    </style>
</head>
<body>
<div class="container">

    <!-- ENTER TRADE DETAILS -->
    <div class="card">
        <div class="card-header">Enter Trade Details</div>
        <div class="card-body">
            <form id="tradeForm">
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label">Stock Symbol</label><input type="text" class="form-control" id="symbol" required></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Contract Type</label>
                        <select class="form-select" id="contractType" required>
                            <option value="Secured Put">Secured Put</option>
                            <option value="Covered Call">Covered Call</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3"><label class="form-label">Contracts</label><input type="number" class="form-control" id="contracts" min="1" required></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Strike Price</label><input type="number" class="form-control" id="strikePrice" step="0.01" min="0.01" required></div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label">Start Date</label><input type="date" class="form-control" id="startDate" required></div>
                    <div class="col-md-3 mb-3"><label class="form-label">End Date</label><input type="date" class="form-control" id="endDate" required></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Fees</label><input type="number" class="form-control" id="fees" step="0.01" min="0" required></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Premium</label><input type="number" class="form-control" id="premium" step="0.01" min="0.01" required></div>
                </div>
                <button type="submit" class="btn btn-custom">Add Trade</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD METRICS -->
    <div class="row dashboard-row">
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Total Fees</h5><p id="totalFees">$0.00</p></div></div>
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Avg Monthly Fee</h5><p id="avgMonthlyFee">$0.00</p></div></div>
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Total Premium (minus fees)</h5><p id="totalPremium">$0.00</p></div></div>
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Monthly Premium</h5><p id="eqMonthlyPremium">$0.00</p></div></div>
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Average Yield</h5><p id="avgYield">0.00%</p></div></div>
        <div class="col-md-2 col-6"><div class="dashboard-metric"><h5>Total Contracts</h5><p id="totalContracts">0</p></div></div>
    </div>

    <div id="perStockMetrics" class="dashboard-row"></div>

    <!-- UPLOAD HISTORICAL DATA -->
    <div class="card">
        <div class="card-header">Upload Historical Data</div>
        <div class="card-body">
            <div class="upload-section">
                <input type="file" id="uploadFile" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" />
                <label for="uploadFile" class="btn btn-custom">Upload</label>
                <span id="fileName">No file selected</span>
                <button class="btn btn-custom" id="processFile" disabled>Process</button>
            </div>
            <div id="uploadError" class="error mt-2"></div>
        </div>
    </div>

    <!-- TOTAL PREMIUM OVER TIME CHART -->
    <div class="card">
        <div class="card-header">Total Premium Over Time
            <button class="btn btn-custom btn-sm" onclick="refreshChart()">Refresh Chart</button>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="yieldChart"></canvas>
            </div>
        </div>
    </div>

    <!-- MONTHLY PREMIUM BREAKDOWN -->
    <div class="card">
        <div class="card-header">Monthly Premium Breakdown</div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr><th>Month</th><th>Total Premium (minus fees)</th><th>Total Fees</th></tr>
                </thead>
                <tbody id="monthlyBreakdownTable"></tbody>
            </table>
        </div>
    </div>

    <!-- TRADE HISTORY WITH NEW YEARLY YIELD COLUMN -->
    <div class="card">
        <div class="card-header">
            <div class="year-tabs-container">
                <div class="year-tabs"><ul class="nav nav-tabs" id="yearTabs"></ul></div>
                Trade History
                <button class="btn btn-custom btn-sm" onclick="exportToExcel()">Export to Excel</button>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th><div class="checkbox-container">
                            <input type="checkbox" id="selectAllTrades" onchange="toggleDeleteAll()">
                            <span class="delete-all-btn" id="deleteAllBtn" onclick="deleteAllTrades()">x</span>
                        </div></th>
                        <th>#</th>
                        <th>Symbol</th>
                        <th>Contract Type</th>
                        <th>Contracts</th>
                        <th>Strike Price</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration (Days)</th>
                        <th>Days to Expiration</th>
                        <th>Fees</th>
                        <th>Premium</th>
                        <th>Total Premium Initial</th>
                        <th>Total Premium Final</th>
                        <th>Yield</th>
                        <th>Yearly Yield</th> <!-- ← NEW COLUMN -->
                    </tr>
                </thead>
                <tbody id="tradeTableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

<script>
let trades = [];
let yieldChart;
let selectedYear = new Date().getFullYear().toString();

const formatCurrency = v => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
const formatPercentage = v => (v*100).toFixed(2) + '%';

const calculateDuration = (s,e) => Math.ceil((new Date(e) - new Date(s)) / 86400000);
const calculateTotalPremiumInitial = (c,p,f) => (c * p * 100) - f;
const calculateYield = (p,f,c,s) => (p - (f/(c*100))) / s;
const calculateDaysToExpiration = (e,t=new Date()) => {
    const d = Math.ceil((new Date(e) - t) / 86400000);
    return d > 0 ? d : '';
};
const calculateYearlyYield = (premium, strike, days) => {
    if (!premium || !strike || days <= 0) return 0;
    return (premium / strike) * 365 / days;
};

// ... (all your original functions: updateDashboard, updateChart, updateMonthlyBreakdown, processFile, validateForm, etc.
// are exactly the same as in your original code – nothing removed or changed)

// Keep the renderTradeTable with the new column
function renderTradeTable() {
    const tbody = document.getElementById('tradeTableBody');
    tbody.innerHTML = '';
    const today = new Date();
    const filtered = selectedYear === 'All' ? trades : trades.filter(t => new Date(t.startDate).getFullYear() == selectedYear);

    filtered.forEach((trade, i) => {
        const idx = trades.indexOf(trade);

        // Auto-close expired trades
        if (!trade.hasManualTotalPremiumFinal && today > new Date(trade.endDate) && trade.totalPremiumFinal === null) {
            trade.totalPremiumFinal = trade.totalPremiumInitial;
            trade.yield = calculateYield((trade.totalPremiumFinal + trade.fees)/(trade.contracts*100), trade.fees, trade.contracts, trade.strikePrice);
        }

        const yearlyYield = calculateYearlyYield(trade.premium, trade.strikePrice, trade.duration);
        const yyClass = yearlyYield >= 0.3 ? 'yearly-yield-high' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="delete-btn" onclick="deleteTrade(${idx})">x</span></td>
            <td>${i+1}</td>
            <td>${trade.symbol}</td>
            <td>${trade.contractType}</td>
            <td>${trade.contracts}</td>
            <td>${formatCurrency(trade.strikePrice)}</td>
            <td>${trade.startDate}</td>
            <td>${trade.endDate}</td>
            <td>${trade.duration}</td>
            <td class="${calculateDaysToExpiration(trade.endDate) ? 'highlight-expiration' : ''}">${calculateDaysToExpiration(trade.endDate)}</td>
            <td>${formatCurrency(trade.fees)}</td>
            <td>${formatCurrency(trade.premium)}</td>
            <td>${formatCurrency(trade.totalPremiumInitial)}</td>
            <td><input type="number" class="editable-input ${trade.hasManualTotalPremiumFinal ? 'manual-input' : ''}" step="0.01" value="${trade.totalPremiumFinal??''}" onchange="updateTotalPremiumFinal(${idx},this.value)" placeholder="-"></td>
            <td>${formatPercentage(trade.yield||0)}</td>
            <td class="${yyClass}">${(yearlyYield*100).toFixed(2)}%</td>
        `;
        tbody.appendChild(row);
    });
    updateYearTabs();
}

// Export includes Yearly Yield
function exportToExcel() {
    const data = trades.map((t,i) => ({
        '#': i+1, Symbol: t.symbol, 'Contract Type': t.contractType, Contracts: t.contracts,
        'Strike Price': t.strikePrice, 'Start Date': t.startDate, 'End Date': t.endDate,
        'Duration (Days)': t.duration, Fees: t.fees, Premium: t.premium,
        'Total Premium Initial': t.totalPremiumInitial,
        'Total Premium Final': t.totalPremiumFinal??'', Yield: t.yield||0,
        'Yearly Yield': calculateYearlyYield(t.premium, t.strikePrice, t.duration)
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Trades');
    XLSX.writeFile(wb, 'options_history.xlsx');
}

// All your original functions (updateDashboard, updateChart, processFile, etc.) go here unchanged...
// (I’m not pasting the entire 600+ lines again to save space – just copy them from your original file)

document.addEventListener('DOMContentLoaded', () => {
    const stored = localStorage.getItem('trades');
    if (stored) trades = JSON.parse(stored);
    renderTrades();
    setupFileUpload();
    setupFormSubmission();
});
</script>
</body>
</html>
